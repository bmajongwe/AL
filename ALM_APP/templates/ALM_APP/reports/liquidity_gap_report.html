<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Liquidity Gap Report</title>
    <style>
        body { font-family: Arial, sans-serif; color: #333; background-color: #f4f4f9; margin: 0; padding: 0; }
        h1 { text-align: center; color: #4CAF50; font-size: 2em; margin-top: 20px; }

        /* Error message styling */
        .error-message-container { max-width: 800px; margin: 10px auto; padding: 15px; background-color: #ffdddd; border: 1px solid #f44336; border-radius: 5px; text-align: center; color: #f44336; font-weight: bold; }

        .filter-container { max-width: 800px; margin: 20px auto; padding: 20px; background-color: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .apply-button, .reset-button { padding: 10px 20px; font-size: 1em; font-weight: bold; border-radius: 4px; cursor: pointer; }
        .apply-button { background-color: #4CAF50; color: white; border: none; }
        .reset-button { background-color: #f44336; color: white; text-decoration: none; border: none; }

        .currency-info { text-align: right; font-weight: bold; color: #007bff; margin-right: 20px; }

        .report-table-container { max-width: 1000px; margin: 20px auto; background-color: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        
        .report-table { width: 100%; border-collapse: collapse; }
        
        /* Header and section title styles */
        .report-table th {
            background-color: #3b5998;
            color: white;
            font-weight: bold;
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        /* Account Type and Product sections styling */
        .report-table td, .report-table th {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .account-type-row {
            background-color: #f5f5f5;
            font-weight: bold;
            text-align: left;
            padding-left: 10px;
            vertical-align: top;
        }

        .product-name { color: #007bff; font-weight: bold; text-align: left; padding-left: 10px; }
        .report-table td { text-align: right; }
        
        .footer-row td {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: left;
            padding-left: 10px;
            border-top: 2px solid #3b5998;
        }

    </style>
</head>
<body>
<!-- Load the custom filter -->
{% load custom_filters %}
    <h1>Liquidity Gap Report</h1>

    <!-- Display error message if present -->
    {% if messages %}
    <div class="error-message-container">
        {% for message in messages %}
            {{ message }}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Filter Form -->
    <div class="filter-container">
        <form method="get" style="display: flex; flex-wrap: wrap; gap: 15px;">
            {{ form.as_p }}
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="submit" class="apply-button">Apply</button>
                <a href="{% url 'liquidity_gap_report' %}" class="reset-button">Reset</a>
            </div>
        </form>
    </div>

    <!-- Report Header -->
    <div class="currency-info">Amount in Millions {{ currency_code }}</div>

    <!-- Detailed Report Table -->
    <div class="report-table-container">
        <table class="report-table">
            <thead>
                <tr>
                    <th>Account Type</th>
                    <th>Product</th>
                    {% for bucket in date_buckets %}
                        <th>{{ bucket.bucket_start_date|date:"d-M-Y" }}<br>{{ bucket.bucket_end_date|date:"d-M-Y" }}</th>
                    {% endfor %}
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <!-- Total Inflows Section -->
                <tr>
                    <td class="account-type-row" rowspan="{{ remaining_inflow_data|length|add:1 }}">Total Inflows</td>
                    <td class="product-name">{{ first_inflow_product.0 }}</td>
                    {% for bucket in date_buckets %}
                        <td>{{ first_inflow_product.1|lookup:bucket.bucket_number|default:"0.00" }}</td>
                    {% endfor %}
                    <td>{{ first_inflow_product.1.total|default:"0.00" }}</td>
                </tr>
                {% for product, buckets in remaining_inflow_data.items %}
                <tr>
                    <td class="product-name">{{ product }}</td>
                    {% for bucket in date_buckets %}
                        <td>{{ buckets|lookup:bucket.bucket_number|default:"0.00" }}</td>
                    {% endfor %}
                    <td>{{ buckets.total|default:"0.00" }}</td>
                </tr>
                {% endfor %}

                <!-- Total Outflows Section -->
                <tr>
                    <td class="account-type-row" rowspan="{{ remaining_outflow_data|length|add:1 }}">Total Outflows</td>
                    <td class="product-name">{{ first_outflow_product.0 }}</td>
                    {% for bucket in date_buckets %}
                        <td>{{ first_outflow_product.1|lookup:bucket.bucket_number|default:"0.00" }}</td>
                    {% endfor %}
                    <td>{{ first_outflow_product.1.total|default:"0.00" }}</td>
                </tr>
                {% for product, buckets in remaining_outflow_data.items %}
                <tr>
                    <td class="product-name">{{ product }}</td>
                    {% for bucket in date_buckets %}
                        <td>{{ buckets|lookup:bucket.bucket_number|default:"0.00" }}</td>
                    {% endfor %}
                    <td>{{ buckets.total|default:"0.00" }}</td>
                </tr>
                {% endfor %}

                <!-- Summary Rows -->
                <tr class="footer-row">
                    <td colspan="2">Net Liquidity Gap</td>
                    {% for bucket in date_buckets %}
                        <td>{{ net_liquidity_gap|lookup:bucket.bucket_number|default:"0.00" }}</td>
                    {% endfor %}
                    <td>{{ net_liquidity_gap.total|default:"0.00" }}</td>
                </tr>
                <tr class="footer-row">
                    <td colspan="2">Net Gap as % of Total Outflows</td>
                    {% for bucket in date_buckets %}
                        <td>{{ net_gap_percentage|lookup:bucket.bucket_number|default:"0.00"|floatformat:2 }}%</td>
                    {% endfor %}
                    <td>{{ net_gap_percentage.total|floatformat:2 }}%</td>
                </tr>
                <tr class="footer-row">
                    <td colspan="2">Cumulative Gap</td>
                    {% for bucket in date_buckets %}
                        <td>{{ cumulative_gap|lookup:bucket.bucket_number|default:"0.00" }}</td>
                    {% endfor %}
                    <td>{{ cumulative_gap.total|default:"0.00" }}</td>
                </tr>
            </tbody>
        </table>
    </div>

</body>
</html>
